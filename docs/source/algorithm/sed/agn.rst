.. _agn-spectrum:

Spectrum of AGN
===============

The AGN spectrum model consists of four components, each corresponding to a physical origin:

- Broad Line Region (BLR),
- Narrow Line Region (NLR),
- Power-law continuum,
- Fe II emission blends.

These components are combined to construct the final AGN spectrum.

Broad Line Region (BLR)
~~~~~~~~~~~~~~~~~~~~~~~

The BLR model generates broad Balmer emission lines (Hε to Hα) based on fixed line ratios from
`Ilić et al. (2006) <https://ui.adsabs.harvard.edu/abs/2006MNRAS.371.1610I/abstract>`_. The key parameters are:

- ``hbeta_flux``: total flux of the Hβ broad line,
- ``hbeta_fwhm``: FWHM of the broad line profile (Gaussian),
- ``vel``: systemic velocity for redshift,
- ``ebv``: dust extinction using the Calzetti law.

The emission lines are constructed on a fine rest-frame wavelength grid, broadened using Gaussian profiles,
scaled by the total Hβ flux, and attenuated by dust extinction. A redshift is applied based on input velocity.

Narrow Line Region (NLR)
~~~~~~~~~~~~~~~~~~~~~~~~

The NLR model uses precomputed flux ratios from photoionization models of
`Feltre et al. (2016) <https://ui.adsabs.harvard.edu/abs/2016MNRAS.456.3354F/abstract>`_, calculated with Cloudy.

Key parameters:

- ``halpha``: total flux of narrow Hα line,
- ``logz``: gas-phase metallicity in :math:`\log(Z/Z_\odot)` used to select flux ratios,
- ``vdisp``: velocity dispersion of ionized gas for line broadening,
- ``vel``: systemic velocity for redshift,
- ``ebv``: dust extinction.

The emission line spectrum is scaled by Hα flux, broadened by convolution with Gaussian profiles,
and corrected for extinction and redshift.

Power-law Continuum
~~~~~~~~~~~~~~~~~~~

The AGN continuum is modeled as a power-law:

.. math::

   F_{\rm PL}(\lambda) \propto \lambda^{\alpha}

where:

- ``alpha``: the power-law slope (default: -1.5),
- ``m5100``: AB magnitude at rest-frame 5100 Å for normalization,
- ``vel``: systemic velocity,
- ``ebv``: dust extinction.

The rest-frame spectrum is normalized using the SDSS-like narrow filter centered at 5100 Å,
and then redshifted and dust-corrected.

Fe II Emission Blends
~~~~~~~~~~~~~~~~~~~~~

The Fe II pseudo-continuum is generated using the empirical template from
`Park et al. (2022) <https://ui.adsabs.harvard.edu/abs/2022ApJS..258...38P/abstract>`_, covering the range:

.. math::

   \lambda \in [4000\,\text{\AA}, 5600\,\text{\AA}]

The Fe II strength is set by the ratio:

.. math::

   R_{4570} = \frac{F_{\rm FeII}(4334{-}4684)}{F_{\rm H\beta}}

where:

- ``hbeta_broad``: total flux of broad Hβ,
- ``r4570``: input Fe II/Hβ ratio (default: 0.4),
- ``vel``: redshift velocity,
- ``ebv``: dust extinction.

The template is scaled by the desired Fe II flux, then dust-corrected and shifted to the observed frame.

Output
------

The final AGN spectrum is generated by summing the fluxes from the BLR, NLR, power-law continuum, and Fe II components,
all interpolated to the target output wavelength grid defined by ``config.wave``.

Each component can be independently toggled or scaled to simulate different AGN types (e.g., type 1 vs. type 2).

